\subsection{Outline}
\label{ss:foa:outline}

In this section, we will prove the freedom of action theorem.
Two versions are stated in \cref{thm:foa,thm:foa_behaviour}.
This will allow us to prove that the collection of model elements we have constructed has size exactly \( \mu \), among other things.
The idea of the theorem is that under suitable hypotheses, a partially defined map of \( \alpha \)-addresses can be extended into an \( \alpha \)-allowable permutation.

There are many different things one could mean by a `partially defined map', and we will need several of these for various purposes.
The two most important forms of partial maps of addresses are \emph{approximations} and \emph{actions}, the former of which will be used in the statement of the theorem.
We will prove some technical results linking approximations and actions.
The version of freedom of action stated in \cref{thm:foa_behaviour} uses a third notion, called \emph{behaviours}.

We will construct the allowable permutation by induction along a particular well-founded relation on addresses: we will define \( \rho((A, x)) \) given the knowledge of \( \rho((B, y)) \) for all \( (B, y) \prec (A, x) \).
In certain cases, we will need to know that the freedom of action theorem holds at all lower levels; we accomplish this by wrapping the entire proof in an induction over all proper type indices below \( \alpha \).

We will then demonstrate that the map as defined is a permutation, and fulfils the criteria to be an allowable permutation.

Our proof for this theorem will not depend on the construction given in \cref{sec:construction}, but rather on an explicit list of properties that the tangles at each level must satisfy for the theorem to hold; this is discussed in \cref{ss:foa:hypotheses}.

\subsection{Partial permutations}
\label{ss:foa:partial_perm}

In the proof of freedom of action, we will often have injective functions that we wish to turn into permutations.
In this subsection, we describe a sufficient condition for such a permutation to exist.

\begin{definition}
    A \emph{partial permutation} on a set \( X \) is a partial function \( f : X \rightdasharrow X \) that is a permutation of its domain.
\end{definition}

Suppose we have an injective partial function \( f : X \rightdasharrow X \).
We will construct a pair of functions \( g \) and \( h \) that agree with \( f \) and its inverse respectively on \( s = \dom f \), in such a way that forms a partial permutation of \( X \).
In particular, consider the diagram
\[\begin{tikzcd}[column sep=small]
	\cdots & {L_2} & {L_1} & {L_0} & {s \setminus f''s} & \cdots & {f''s \setminus s} & {R_0} & {R_1} & {R_2} & \cdots
	\arrow[from=1-1, to=1-2]
	\arrow[from=1-2, to=1-3]
	\arrow[from=1-3, to=1-4]
	\arrow[from=1-4, to=1-5]
	\arrow["f", from=1-5, to=1-6]
	\arrow["f", from=1-6, to=1-7]
	\arrow[from=1-7, to=1-8]
	\arrow[from=1-8, to=1-9]
	\arrow[from=1-9, to=1-10]
	\arrow[from=1-10, to=1-11]
\end{tikzcd}\]
To fill in the orbits of \( f \), we construct a sequence of disjoint subsets of \( X \) called \( L_n \) and \( R_n \), where for each \( i : \mathbb N \), the cardinality of \( L_i \) is the same as \( s \setminus f''s \), and the cardinality of \( R_i \) is that of \( f''s \setminus s \).
There are natural bijections along this diagram, mapping \( L_{n + 1} \) to \( L_n \) and \( R_n \) to \( R_{n + 1} \).
There are also bijections \( f '' s \setminus s \to R_0 \) and \( L_0 \to s \setminus f '' s \).
This completes the diagram, giving a partial permutation extending \( f \) defined on
\[ s \cup f '' s \cup \left( \bigcup_{i \in \mathbb N} L_i \right) \cup \left( \bigcup_{i \in \mathbb N} R_i \right) \]

\subsection{Hypotheses}
\label{ss:foa:hypotheses}

Let \( \alpha \) be a proper type index.
The complete list of hypotheses we will use when proving the freedom of action theorem at all levels \( \beta \leq \alpha \) are as follows.
\begin{enumerate}
    \item We assume that we have tangle data and typed near-litters at all proper type levels \( \beta \leq \alpha \).
    The data for level \( \alpha \) will later be provided by running the construction in \cref{sec:construction}.
    We also assume position functions at all proper type levels \( \beta < \alpha \).
    \item We assume that the groups of allowable permutations \( A_\beta \) can be related by the use of a derivative map.
    Each path \( A : \beta \rightsquigarrow \gamma \) gives rise to a group homomorphism \( A_\beta \to A_\gamma \), and its action on an allowable \( \rho \) is denoted \( \rho_A \).
    We assume that the following diagram commutes.
    \[\begin{tikzcd}
        {A_\beta} & {S_\beta} \\
        {A_\gamma} & {S_\gamma}
        \arrow[from=1-1, to=1-2]
        \arrow["{\pi \mapsto \pi_A}", from=1-2, to=2-2]
        \arrow["{\rho \mapsto \rho_A}"', from=1-1, to=2-1]
        \arrow[from=2-1, to=2-2]
    \end{tikzcd}\]
    Alternatively, viewing allowable permutations as subgroups of structural permutations, this assumption states that any derivative of an allowable permutation is also allowable.
    \item Let \( \beta < \alpha \) be a proper type index and let \( t \in \tau_\beta \).
    Let \( \gamma < \alpha \) be a type index, let \( \delta < \alpha \) be a proper type index distinct from \( \gamma \), and let \( s \in \tau_\gamma \).
    Suppose that \( (A, x) \in \ran \supp t \), where \( A \) is a \( \beta \)-extended type index and \( x \) is an atom or a near-litter.
    Suppose further that either \( x = a \) is an atom with \( a^\circ = f_{\gamma,\delta}(s) \), or that \( x = N \) is a near-litter that has nonempty intersection with \( \LS(f_{\gamma,\delta}(s)) \).
    Then \( \iota_\gamma(s) < \iota_\beta(t) \).
    \item Let \( \beta \leq \alpha \) be a type index, let \( \gamma < \alpha \) be a type index, and let \( \delta < \alpha \) be a proper type index distinct from \( \gamma \).
    Let \( \rho \) be a \( \beta \)-allowable permutation, and let \( t \) be a \( \gamma \)-tangle.
    Then
    \[ \rho_{(\beta > \delta > \bot)}(f_{\gamma,\delta}(t)) = f_{\gamma,\delta}(\rho_{(\beta > \gamma)}(t)) \]
    This is a restatement of equation (\( \ast \)) from \cref{def:allowable}, and is sometimes called the \emph{coherence condition} for allowable permutations.
    \item Conversely, let \( \beta \leq \alpha \) be a type index, and let \( \rho_{(\beta > \gamma)} \) be a \( \gamma \)-allowable permutation for each type index \( \gamma < \beta \).
    Suppose that the \( \rho_{(\beta > \gamma)} \) satisfy the one-step fuzz constraints
    \[ (\rho_{(\gamma >\delta)})_{(\delta > \bot)}(f_{\gamma,\delta}(t)) = f_{\gamma,\delta}(\rho_{(\beta > \gamma)}(t)) \]
    Then we can assemble the \( \rho_{(\beta > \gamma)} \) into a \( \beta \)-allowable permutation; more precisely, there exists an allowable permutation \( \rho \) with one-step derivatives given by the \( \rho_{(\beta > \gamma)} \).
\end{enumerate}

\begin{remarks}\mbox{\negthinspace}
    \begin{enumerate}
        \item Apart from (iii), these conditions are obviously satisfied by our construction in \cref{sec:construction}.
        Note that this remaining condition only constrains type indices strictly below \( \alpha \), so we may carry this knowledge through the main inductive step.
        Once we know that a given type is of size \( \mu \), a position function can be constructed in such a way to make (iii) hold, using a similar method to the construction of the fuzz map in \cref{def:fuzz}.
        \item Hypothesis (v) will be used exactly once, at the end of freedom of action.
        This will allow us to build the allowable permutation asserted in the theorem.
    \end{enumerate}
\end{remarks}

\subsection{Dependency of addresses}

As described in \cref{ss:foa:outline}, we will define a well-founded relation on the set of \( \alpha \)-addresses that will allow us to define the action of an allowable permutation recursively.

\begin{definition}
    \label{def:dependency}
    Let \( \beta \leq \alpha \) be a proper type index.
    We define the \emph{dependency} relation \( \prec \) on \( \beta \)-support conditions by the following constructors.
    \begin{enumerate}
        \item Let \( A \) be a \( \beta \)-extended index, and let \( a \) be an atom.
        Then
        \[ (A, \NL(a^\circ)) \prec (A, a) \]
        \item Let \( A \) be a \( \beta \)-extended index, and let \( N \) be a near-litter with \( N \neq \NL(N^\circ) \).
        Then
        \[ (A, \NL(N^\circ)) \prec (A, N) \]
        \item Let \( A \) be a \( \beta \)-extended index, let \( N \) be a near-litter, and let \( a \) be an atom in the symmetric difference \( N \symmdiff \LS(N^\circ) \).
        Then
        \[ (A, a) \prec (A, N) \]
        \item Let \( \gamma \leq \alpha \) be a proper type index, and let \( \delta, \varepsilon < \gamma \) be distinct proper type indices.
        Let \( A \) be a path \( \beta \rightsquigarrow \gamma \) and let \( t \in \tau_\delta \).
        Then for all \( c \in \ran \supp t \),
        \[ (A \gg (\gamma > \delta) \gg \pr_1(c), \pr_2(c)) \prec (A \gg (\gamma > \varepsilon > \bot), \NL(f_{\delta,\varepsilon}(t))) \]
        \item Let \( \gamma \leq \alpha \) be a proper type index, and let \( \varepsilon < \gamma \) be a proper type index.
        Let \( A \) be a path \( \beta \rightsquigarrow \gamma \) and let \( a \) be an atom.
        Then
        \[ (A \gg (\gamma > \bot), a) \prec (A \gg (\gamma > \varepsilon > \bot), \NL(f_{\bot,\varepsilon}(a))) \]
    \end{enumerate}
    If \( x \prec y \), we say that \( y \) \emph{depends on} \( x \).
\end{definition}

\begin{remarks}\mbox{\negthinspace}
    \begin{enumerate}
        \item Let \( x \) be an address and \( \rho \) be an allowable permutation we wish to study, and suppose we know the values of \( \rho(y) \) for \( y \prec x \).
        We can then deduce some useful information about the possible values of \( \rho(x) \), and in some cases determine it exactly (for instance, if \( x \) is a near-litter \( N \neq \NL(N^\circ) \)).
        \item Each address depends on only a small set of other addresses.
        This holds as supports have small ranges.
        \item A litter is said to be \emph{inflexible} with respect to a particular \( \beta \)-extended index if it is the image of a fuzz map as given by constructors (iv) or (v) above.
        A litter is \emph{flexible} with respect to an extended index if it is not inflexible.
        The addresses formed from flexible litters are minimal elements under \( \prec \).
        It is technically possible for an address formed from an inflexible litter to be minimal under \( \prec \) if its support is empty, but aside from this pathology, this is a full description of the minimal elements.
    \end{enumerate}
\end{remarks}

\begin{proposition}
    The dependency relation is well-founded.
\end{proposition}
\begin{proof}
    If \( X \) is a set endowed with a relation \( \prec \), we say that \( x \in X \) is \emph{\( \prec \)-accessible} if all of its \( \prec \)-predecessors are \( \prec \)-accessible.
    A relation on \( X \) is well-founded precisely when every \( x \in X \) is accessible under that relation.
    We make the following observations about accessibility of addresses under the dependency relation, both of which follow directly from the relevant definitions.
    \begin{enumerate}
        \item Let \( A \) be a \( \beta \)-extended type index, and let \( a \) be an atom.
        Then \( (A, a) \) is accessible if \( (A, \NL(a^\circ)) \) is accessible.
        \item Let \( A \) be a \( \beta \)-extended type index, and let \( N \) be an near-litter.
        Then \( (A, N) \) is accessible if \( (A, \NL(a^\circ)) \) is accessible for all \( a \in N \).
    \end{enumerate}
    We have thus reduced accessibility of arbitrary addresses to accessibility of litter addresses.
    Motivated by this, we will define an auxiliary relation \( R \) on litters and prove that it is well-founded.
    We define the following constructors for \( R \).
    \begin{enumerate}
        \item Let \( \delta, \varepsilon < \alpha \) be distinct proper type indices, and let \( t \in \tau_\delta \).
        Then if \( B \) is an extended index and \( a \) is an atom such that either \( (B, a) \in \ran \supp t \) or \( (B, N) \in \ran \supp t \) and \( a \in N \), then
        \[ a^\circ \mathrel{R} f_{\delta,\varepsilon}(t) \]
        \item Let \( \varepsilon < \alpha \) be a proper type index, and let \( a \) be an atom.
        Then
        \[ a^\circ \mathrel{R} f_{\bot,\varepsilon}(a) \]
    \end{enumerate}
    We will say that a litter \( L \) has position \( \nu \in \mu \) if either
    \begin{enumerate}
        \item \( \delta, \varepsilon < \alpha \) are distinct proper type indices, \( t \in \tau_\delta \), and
        \[ L = f_{\delta,\varepsilon}(t); \quad \nu = \iota(t) \]
        or
        \item \( \varepsilon < \alpha \), \( a \) is an atom, and
        \[ L = f_{\bot,\varepsilon}(a); \quad \nu = \iota(a) \]
    \end{enumerate}
    First, note that a litter has at most one position; this follows by injectivity of the fuzz map.
    It follows by definition that if \( L_1 \mathrel{R} L_2 \), then \( L_2 \) has a position.
    Moreover, if additionally \( L_1 \) has a position, its position is less than that of \( L_2 \).
    This last fact follows from part (iii) of the definition of the fuzz map in \cref{def:fuzz}, as well as hypothesis (iii) in \cref{ss:foa:hypotheses}.
    In particular, as the order on \( \mu \) is well-founded, the relation \( R \) must also be well-founded.

    We show by induction on \( R \) that for every litter \( L \) and \( \beta \)-extended index \( A \), the address \( (A, \NL(L)) \) is accessible; the result then follows from the observations above, since they concern only litter addresses.
    Suppose \( c \prec (A, \NL(L)) \); we must show \( c \) is accessible.
    Only cases (iv) and (v) of \cref{def:dependency} can possibly occur.
    Suppose \( c = (B, a) \) and \( L = f_{\delta,\varepsilon}(t) \).
    Then by observation (i), it suffices to show \( (B, \NL(a^\circ)) \) is accessible, but this is given by the inductive hypothesis.
    If \( c = (B, N) \) and \( L = f_{\delta,\varepsilon}(t) \), then the result similarly holds by applying observation (ii) to the inductive hypothesis.
    Finally, if \( c = (B, a) \) and \( L = f_{\bot,\varepsilon}(a) \), then again the result holds by observation (i) and the inductive hypothesis.
\end{proof}

\begin{remark}
    If \( x \prec y \) are \( \gamma \)-addresses and \( B \) is a path \( \beta \rightsquigarrow \gamma \), then
    \[ (B \gg \pr_1(x), \pr_2(x)) \prec (B \gg \pr_1(y), \pr_2(y)) \]
\end{remark}

We will define a partial order on addresses by defining \( < \) to be the transitive closure of \( \prec \).
Evidently, the relation \( < \) is also well-founded.

\subsection{Approximations and the theorem statement}

We can now define one notion of a partially defined map of addresses.

\begin{definition}
    A \emph{near-litter approximation} is a pair \( \varphi = (\varphi^A, \varphi^L) \) where \( \varphi^A \) is a partial permutation of atoms, \( \varphi^L \) is a partial permutation of litters, and the domain of \( \varphi^A \) contains only a small number of atoms associated to a given litter \( L \).
\end{definition}

For brevity, we will often suppress the superscripts on approximations.

\begin{definition}
    An atom \( a \) is said to be \emph{exceptional} in a near-litter permutation \( \pi \) if \[ (\pi(a))^\circ \neq \pi(a^\circ) \quad\text{or}\quad (\pi^{-1}(a))^\circ \neq \pi^{-1}(a^\circ) \]
\end{definition}
\begin{definition}
    A near-litter approximation \( \varphi \) is said to \emph{approximate} a near-litter permutation \( \pi \) when they agree at all atoms and litters at which \( \varphi \) is defined:
    \[ \forall a \in \dom \varphi^A.\, \pi(a) = \varphi(a);\quad \forall L \in \dom \varphi^L.\, \pi(L) = \varphi(L) \]
    and additionally that all exceptional atoms in \( \pi \) are in \( \dom \varphi^A \).
\end{definition}

\begin{remark}
    In \cite{holmes2023nf}, Holmes makes a distinction between merely `approximating' a permutation and `exactly approximating' it.
    We make no use of the weaker notion, so we will refer to `exactly approximating' as simply `approximating'.
\end{remark}

\begin{remark}
    If \( \varphi \) approximates \( \pi \), we can determine the exact image of \( \pi(\NL(L)) \) for any litter \( L \in \dom \varphi^L \) from data in \( \varphi \).
    It can be shown directly that every near-litter approximation approximates some near-litter permutation, although we will not need this fact.
\end{remark}

In the same way that structural permutations were built up from near-litter permutations in \cref{def:struct_perm}, we will build up structural approximations from near-litter approximations.

\begin{definition}
    Let \( \beta \) be a type index.
    A \emph{\( \beta \)-structural approximation} \( \varphi \) assigns a near-litter approximation to each \( \beta \)-extended index.
    For a given \( \beta \)-extended index \( A \), the assigned near-litter permutation is denoted \( \varphi_A \).
    A \( \beta \)-structural approximation \( \varphi \) is said to \emph{(exactly) approximate} a \( \beta \)-structural permutation \( \pi \) if \( \varphi_A \) (exactly) approximates \( \pi_A \) for all \( \beta \)-extended indices \( A \).
    We say that \( \beta \) is \emph{free} if for all \( \beta \)-extended indices \( A \), the only litters that appear in \( \dom (\varphi_A)^L \) are \( A \)-flexible.
\end{definition}

We can now state one form of the freedom of action theorem.
\Cref{thm:foa_behaviour} is a slightly weaker statement of the same result, but is often more useful in practice.

\begin{theorem}[freedom of action]
    \label{thm:foa}
    Let \( \beta \leq \alpha \) be a proper type index.
    Then any free \( \beta \)-structural approximation \( \varphi \) approximates some \( \beta \)-allowable permutation \( \rho \).
\end{theorem}

\begin{remarks}\mbox{\negthinspace}
    \begin{enumerate}
        \item This theorem extends the fact that any near-litter approximation approximates some near-litter permutation; in fact, this statement is precisely freedom of action for \( \beta = \bot \).
        \item If \( L \) is \( A \)-inflexible, then the value of \( \rho_A(L) \) depends on a the value of a certain tangle under \( \rho \), so we may not choose it freely.
        The freedom of action theorem states that this is the only restriction to the images of litters under allowable permutations.
        \item The theorem is phrased in terms of approximations, although this is somewhat arbitrary.
        The purpose of the theorem is to construct allowable permutations, but the data we need to encapsulate in an allowable permutation may come in various different forms.
        \item As described in \cref{ss:outline:size}, we will later use the freedom of action theorem to show that the set of \( \alpha \)-objects has cardinality exactly \( \mu \).
    \end{enumerate}
\end{remarks}

\subsection{Actions}

We will now introduce another form of data that can be used as the input to the freedom of action theorem.

\begin{definition}
    A \emph{near-litter action} is a pair \( \psi = (\psi^A, \psi^L) \) where \( \psi^A \) is a partial function from the set of atoms to itself, \( \psi^L \) is a partial function from the set of litters to the set of near-litters, and both \( \psi^A \) and \( \psi^L \) have small domain.
\end{definition}

As with approximations, we will suppress the superscripts when possible.

\begin{remarks}\mbox{\negthinspace}
    \begin{enumerate}
        \item The function \( \psi^L \) encapsulates the mapping \( L \mapsto \pi(\NL(L)) \), whereas for near-litter approximations \( \varphi \), the function \( \varphi^L \) encapsulates \( L \mapsto \pi(L) \).
        In this way, near-litter actions keep track of more data about where a litter is sent under a permutation, since we know precisely where its set of atoms is sent.
        \item The appropriate notion of approximating a permutation here is that
        \[ \forall a \in \dom \psi^A.\, \pi(a) = \psi(a);\quad \forall L \in \dom \psi^L.\, \pi(\NL(L)) = \psi(L) \]
        We need no distinction between approximating and exactly approximating since near-litter actions already capture precise images of litters.
        % TODO: I think this should be in Lean!
        % We can use this idea to define the data format we need for support shenanigans.
        Not every near-litter action approximates some near-litter permutation, because we may have a situation where \( a \in \dom \psi^A, a^\circ \in \dom \psi^L \) but \( \psi(a) \notin \psi(a^\circ) \).
        This pathology, as well as injectivity, turns out to be the only way in which near-litter actions can fail to approximate some near-litter permutation.
        We therefore make the following definition.
    \end{enumerate}
\end{remarks}

\begin{definition}
    A near-litter action \( \psi \) is said to be \emph{lawful} if
    \begin{enumerate}
        \item if \( a_1, a_2 \) are atoms and \( \psi(a_1) = \psi(a_2) \) then \( a_1 = a_2 \);
        \item if \( L_1, L_2 \) are litters and \( \psi(L_1) \cap \psi(L_2) \neq \varnothing \) then \( L_1 = L_2 \);
        \item if \( a \in \dom \psi^A \) and \( L \in \dom \psi^L \), then \( a^\circ = L \) if and only if \( \psi(a) \in \psi(L) \).
    \end{enumerate}
\end{definition}

We now describe a procedure for converting lawful near-litter actions into free near-litter approximations.
This process has two steps: expanding the near-litter action so that it is \emph{precise}, and then completing it into an approximation.

\begin{definition}
    % TODO: this might be wrong, check defs
    \label{def:precise}
    A near-litter action \( \psi \) is said to be \emph{precise} if for all \( L \in \dom \psi^L \),
    \begin{enumerate}
        \item \( \psi(L) \symmdiff \LS(\psi(L)^\circ) \subseteq \ran \psi^A \);
        \item \( \ran \psi^A \cap \LS(L) \subseteq \dom \psi^A \);
        \item \( \dom \psi^A \cap \psi(L) \subseteq \ran \psi^A \).
    \end{enumerate}
\end{definition}

These are precisely the requirements that our completion process needs in order to compute complete orbits for all atoms and litters.

\begin{lemma}
    \label{lem:foa:precise}
    Any lawful near-litter action can be extended to a precise near-litter action with the same map on litters.
\end{lemma}
This proof is explicit, but unenlightening.
\begin{proof}
    Let \( \psi \) be a near-litter action.
    Call a litter \emph{banned} for \( \psi \) if it contains any atom in the domain or range of \( \psi^A \), is in \( \dom \psi^L \), or shares an atom with any near-litter in \( \ran \psi^L \).
    Observe that there are only a small amount of banned litters for a given \( \psi \).
    We will use the unbanned litters to store the extra atoms we need to insert into \( \psi \).

    We will first extend \( \psi \) so that it satisfies condition (i) in \cref{def:precise}.
    Suppose that \( a \in \LS(\psi(L)^\circ) \setminus \psi(L) \); we need to allocate a preimage for \( a \) under \( \psi \).
    Choose an atom \( a' \) in an unbanned litter, and add to \( \psi^A \) that \( \psi(a') = a \).
    The addition of \( a' \) to \( \psi \) does not create more problems with satisfying \cref{def:precise}, since \( a' \) is part of an unbanned litter.
    There are only a small amount of atoms in such circumstances, so they can all be added to the same unbanned litter for convenience.

    Now suppose that \( a \in \psi(L) \setminus \LS(\psi(L)^\circ) \).
    We need to allocate a preimage for \( a \) under \( \psi \) that lies in \( L \).
    Since there are only a small amount of atoms in question, and only a small amount of atoms in \( L \) already appear in \( \dom \psi^A \), we can fit all necessary preimages inside \( L \).
    Again, this does not create any more problematic atoms that we must deal with.
    Performing this process for every \( L \in \dom \psi^L \), we obtain a new near-litter action \( \psi' \) which satisfies condition (i) of \cref{def:precise} and has the same litter map as \( \psi \).
    One can easily check that \( \psi' \) is lawful.

    We now extend \( \psi' \) so that it satisfies conditions (ii) and (iii), while not disturbing condition (i).
    To do this, we need to fill in certain images and preimages of atoms.
    First, use the construction in \cref{ss:foa:partial_perm} to produce a partial permutation of litters \( \pi \) extending \( L \mapsto \psi'(L)^\circ \).
    We require that all extra litters used to make \( \dom \pi \) are unbanned; this can be arranged since we have a choice of \( \mu \) unbanned litters to use.
    We then extend \( \pi \) to be defined on all banned litters by setting \( \pi(L) = L \) in this case; the resulting map is clearly still a partial permutation.
    This map will be used to control the litters inside which the new images and preimages of atoms under \( \psi' \) will be allocated.
    For now, we will describe only the allocation of forward images; backward images work entirely symmetrically.

    Inside each litter, we reserve enough unused atoms to correspond with all possible pairs \( (n, a) \) where \( a \in \ran \psi^A \setminus \dom \psi^A \).
    We then define that an atom \( a \in \ran \psi^A \setminus \dom \psi^A \) is mapped to the atom corresponding to \( (0, a) \) in the litter \( \pi(a^\circ) \).
    If \( a' \) is an atom corresponding to \( (n, a) \) in the litter \( \pi^{n+1}(a^\circ) \), then it is mapped to the atom corresponding to \( (n+1, a) \) in the litter \( \pi^{n+2}(a^\circ) \).
    This behaviour ensures that we our extra atoms do not violate condition (i) of \cref{def:precise}.
    Note that most atoms corresponding to one of the pairs \( (n, a) \) will not have an image defined.
    This completes the description of the forward orbits; after filling the backward orbits analogously, the resulting near-litter action \( \psi'' \) can be seen to be precise and lawful.
\end{proof}

We now describe the method for turning a precise action into a free approximation.

\begin{lemma}
    \label{lem:foa:nl_action_to_approx}
    Let \( \psi \) be a precise lawful near-litter action and let \( A \) be a \( \beta \)-extended index.
    Suppose that \( \psi \) maps \( A \)-flexible litters to near-litters that are near \( A \)-flexible litters.
    Then there is a near-litter approximation \( \varphi \) whose litter map contains only \( A \)-flexible litters, such that if \( \varphi \) approximates \( \pi \), we have
    \begin{enumerate}
        \item if \( a \in \dom \psi^A \), then \( \psi(a) = \pi(a) \);
        \item if \( L \in \dom \psi^L \) is \( A \)-flexible, then \( \psi(L)^\circ = \pi(L) \); and
        \item if \( L \in \dom \psi^L \) and \( \psi(L)^\circ = \pi(L) \), then \( \psi(L) = \pi(\NL(L)) \).
    \end{enumerate}
\end{lemma}
This lemma provides exactly what is needed to use the freedom of action theorem with actions instead of approximations directly.
We will shortly restate this lemma in a more useful form.
\begin{proof}
    First, consider the restriction of \( \psi^L \) to the \( A \)-flexible litters.
    This map can be completed to a partial permutation \( \varphi^L \) as in \cref{ss:foa:partial_perm}, where any added litters are flexible and unbanned; there is a supply of \( \mu \) such litters, so this can always be arranged.
    We similarly complete \( \psi^A \) into a partial permutation \( \varphi^A \); the added atoms are chosen to belong to another unbanned litter.
    This yields a near-litter approximation \( \varphi = (\varphi^A, \varphi^L) \).
    We claim that this satisfies the conclusion of the lemma.
    It is clear that (i) and (ii) hold.
    Part (iii) can be shown by checking all possible cases of where an atom can come from and be sent; this requires the full strength of the hypothesis that \( \psi \) was precise.
\end{proof}

This concludes the main work of this subsection.
We now briefly describe how near-litter actions are composed to form structural actions, and combine \cref{lem:foa:precise,lem:foa:nl_action_to_approx} to make an easy way to apply freedom of action to structural actions.

\begin{definition}
    Let \( \beta \) be a type index.
    A \emph{\( \beta \)-structural action} \( \psi \) assigns a near-litter action to each \( \beta \)-extended index.
    For a given \( \beta \)-extended index \( A \), the assigned near-litter action is denoted \( \psi_A \).
    We say that \( \beta \) is \emph{lawful} if for all \( \beta \)-extended indices \( A \), the near-litter action \( \psi_A \) is lawful.
\end{definition}

\begin{proposition}
    \label{lem:foa:struct_action_to_approx}
    Let \( \psi \) be a lawful \( \beta \)-structural action.
    Suppose that for every \( \beta \)-extended index \( A \), the near-litter action \( \psi_A \) maps \( A \)-flexible litters to near-litters that are near \( A \)-flexible litters.
    Then there is a free \( \beta \)-structural approximation such that if \( \varphi \) approximates \( \pi \), we have
    \begin{enumerate}
        \item if \( a \in \dom{(\psi_A)^A} \), then \( \psi_A(a) = \pi_A(a) \);
        \item if \( L \in \dom{(\psi_A)^L} \) is \( A \)-flexible, then \( \psi_A(L)^\circ = \pi_A(L) \); and
        \item if \( L \in \dom{(\psi_A)^L} \) and \( \psi_A(L)^\circ = \pi_A(L) \), then \( \psi(L) = \pi_A(\NL(L)) \).
    \end{enumerate}
\end{proposition}
\begin{proof}
    Follows directly from \cref{lem:foa:precise,lem:foa:nl_action_to_approx}.
\end{proof}

We will sometimes convert actions to approximations, then convert approximations to allowable permutations using freedom of action.
Even though freedom of action only guarantees nice behaviour to flexible litters, we can show that any two suitably similar allowable permutations created in this way must agree on arbitrary litters.

\begin{definition}
    \label{def:exact}
    Let \( \pi_1, \pi_2 \) be \( \beta \)-structural permutations, and let \( x \) be a \( \beta \)-address.
    We say that \( \pi_1 \) and \( \pi_2 \) are \emph{exact before \( x \)} if:
    \begin{enumerate}
        \item for all \( (A, a) \leq x \), we have \( (\pi_1)_A(a) = (\pi_2)_A(a) \);
        \item for all \( (A, \NL(L)) \leq x \) where \( L \) is \( A \)-flexible, we have \( (\pi_1)_A(L) = (\pi_2)_A(L) \);
        \item for all \( (A, \NL(L)) \leq x \), if \( (\pi_1)_A(L) = (\pi_2)_A(L) \), then \( (\pi_1)_A(\NL(L)) = (\pi_2)_A(\NL(L)) \).
    \end{enumerate}
\end{definition}

\begin{lemma}
    \label{lem:exact}
    Let \( \rho_1, \rho_2 \) be \( \beta \)-allowable permutations.
    If \( \rho_1, \rho_2 \) are exact before \( x \), then \( \rho_1(x) = \rho_2(x) \).
\end{lemma}
\begin{proof}
    We prove this by induction on \( x \) along the dependency relation.
    If \( x = (A, a) \) is an atom address, the conclusion holds by part (i) of \cref{def:exact}.
    If \( x = (A, N) \) is a near-litter address with \( N \neq \NL(N^\circ) \), we are done immediately by applying the inductive hypothesis.
    If \( x = (A, \NL(L)) \) where \( L \) is a litter, we use part (iii) of \cref{def:exact} to reduce to proving \( (\rho_1)_A(L) = (\rho_2)_A(L) \).
    If \( L \) is \( A \)-flexible, the result holds by (ii), and if \( L \) is \( A \)-inflexible, the result holds by the coherence condition on allowable permutations.
\end{proof}

\subsection{Building the permutation}
\label{ss:foa:construction}

We now begin to prove the freedom of action theorem.
Fix a proper type index \( \beta \leq \alpha \) and a free \( \beta \)-structural approximation \( \varphi \).
We may assume by induction on \( \lambda \) that the freedom of action holds for all proper type indices \( \gamma < \beta \); we will use this in \cref{ss:foa:inflexible_coe}.

We will construct the functions \( \rho^\star_A \) which map atoms to atoms, litters to litters, and near-litters to near-litters, with the intent that they will be the derivatives of an allowable permutation \( \rho \).
We will proceed by recursion along the transitive closure of the dependency relation from \cref{def:dependency}; at each stage \( (A, x) \), we assume that we know the value of \( \rho^\star_B(y) \) for all \( (B, y) < (A, x) \), and compute \( \rho^\star_A(x) \).
This construction will take a different form depending on what kind of address \( (A, x) \) is.
In particular, if \( x = \NL(L) \) is a near-litter that came from a litter, we will break the derivation into two stages: we will first compute \( \rho^\star_A(L) \), and then calculate \( \rho^\star_A(\NL(L)) \) separately.

\subsubsection{Atoms}

Suppose we are at stage \( (A, a) \) where \( a \) is an atom.
If \( a \) was already assigned by \( \varphi \), we simply define
\[ \rho^\star_A(a) = \varphi_A(a) \]
Suppose \( a \notin \dom (\varphi_A)^A \).
For each extended index \( A \) and litter \( L \), the set \( L^- = L \setminus \dom (\varphi_A)^A \) is a near-litter, near the litter \( L \).
For each pair of litters \( L_1, L_2 \), we choose in advance a bijection \( \pi_{L_1,L_2} \) between \( L_1^- \) and \( L_2^- \).
We use this bijection now to define
\[ \rho^\star_A(a) = \pi_{a^\circ,\rho^\star_A(a^\circ)}(a) \]

\subsubsection{Flexible litters}
\label{ss:foa:flexible}

Suppose we are at stage \( (A, \NL(L)) \) where \( L \) is \( A \)-flexible.
If \( L \in \dom (\varphi_A)^L \), then we must define
\[ \rho^\star_A(L) = \varphi_A(L)^\circ \]
Otherwise, we will define that
\[ \rho^\star_A(L) = L \]

\subsubsection{Inflexible litters from proper levels}
\label{ss:foa:inflexible_coe}

Suppose we are at stage
\[ x = (A \gg (\gamma > \varepsilon > \bot), \NL(f_{\delta,\varepsilon}(t))) \]
where \( \delta, \varepsilon < \gamma \) are distinct proper type indices, \( A \) is a path \( \beta \rightsquigarrow \gamma \), and \( t \in \tau_\delta \).
We need to enforce the coherence condition that
\[ \rho_{(A \gg (\gamma > \varepsilon > \bot))}(f_{\delta,\varepsilon}(t)) = f_{\delta,\varepsilon}(\rho_{(A \gg (\gamma > \delta))}(t)) \]
Thus, we need to compute the right-hand side of this equation.
However, we do not know if \( \rho^\star \) happens to come from an allowable permutation, so there is no way to apply it to an arbitrary tangle \( t \).
To deal with this, we invoke the freedom of action theorem at level \( \delta \) to produce a new allowable permutation \( \rho' \) with the same action on \( t \) as \( \rho_{(A \gg (\gamma > \delta))} \) will eventually be shown to have.

For a given small set of addresses \( s \), there is a structural action \( \psi^s \) with
\[ a \in \dom (\psi^s_A)^A \iff (A, a) \in s;\quad L \in \dom (\psi^s_A)^L \iff (A, \NL(L)) \in s \]
given by \( \rho^\star \) on its domain.
In particular, we can define
\[ \psi^x = \psi^s;\quad s = \{ y \mid y < x \} \]
We will consider its derivative \( \psi^x_{(A \gg (\gamma > \delta))} \), which is a \( \delta \)-strutural action.
Outside of this recursion, we will be able to show that \( \psi^x_{(A \gg (\gamma > \delta))} \) is lawful and maps flexible litters to flexible litters as required for \cref{lem:foa:struct_action_to_approx}; for now, if it turned out not to be lawful, we would simply assign
\[ \rho^\star_{A \gg (\gamma > \varepsilon > \bot)}(f_{\delta,\varepsilon}(t)) = f_{\delta,\varepsilon}(t) \]
but this case will never actually occur.
Build a \( \delta \)-structural approximation from \( \psi^x_{(A \gg (\gamma > \delta))} \) as in \cref{lem:foa:struct_action_to_approx}, and apply the freedom of action theorem at level \( \delta < \gamma \leq \beta \) to obtain a \( \delta \)-allowable permutation \( \rho^x \).
We will later be able to show that \( \rho^x \) agrees with \( \rho^\star \) on all elements of the support of \( t \).
We set
\[ \rho^\star_{A \gg (\gamma > \varepsilon > \bot)}(f_{\delta,\varepsilon}(t)) = f_{\delta,\varepsilon}(\rho^x(t)) \]

\subsubsection{Inflexible litters from the base level}
\label{ss:foa:inflexible_bot}

Suppose we are at stage
\[ x = (A \gg (\gamma > \varepsilon > \bot), \NL(f_{\bot,\varepsilon}(a))) \]
where \( \varepsilon < \gamma \) is a proper type index, \( A \) is a path \( \beta \rightsquigarrow \gamma \), and \( a \) is an atom.
We must enforce
\[ \rho_{(A \gg (\gamma > \varepsilon > \bot))}(f_{\bot,\varepsilon}(a)) = f_{\bot,\varepsilon}(\rho_{(A \gg (\gamma > \bot))}(a)) \]
so we have no choice but to define
\[ \rho^\star_{A \gg (\gamma > \varepsilon > \bot)}(f_{\bot,\varepsilon}(a)) = f_{\bot,\varepsilon}(\rho^\star_{(A \gg (\gamma > \bot))}(a)) \]

\subsubsection{Near-litters}

Suppose we are at stage \( (A, N) \) where \( N \) is a near-litter.
Either by inductive hypothesis or by \cref{ss:foa:flexible,ss:foa:inflexible_coe,ss:foa:inflexible_bot}, we know the value of \( \rho^\star_A(N^\circ) \).
We then define
\[ \pr_2 (\rho^\star_A(N)) = \left( \rho^\star_A(N^\circ)^- \cup {\psi_A} '' \left(N \cap \dom{(\psi_A)^A}\right) \right) \symmdiff \left\{ \rho^\star_A(a) \mid a \in (N \symmdiff \LS(N^\circ)) \setminus \dom{(\psi_A)^A} \right\} \]
In the case that \( N = \NL(L) \), this simplifies to
\[ \pr_2 (\rho^\star_A(\NL(L))) = \rho^\star_A(L)^- \cup {\psi_A} '' \left(\LS(L) \cap \dom{(\psi_A)^A}\right) \]
This definition has the property that
\[ \rho^\star_A(N) = \rho^\star_A(\NL(N^\circ)) \symmdiff {\rho^\star_A} '' (N \symmdiff \LS(N^\circ)) \]
and that for any two distinct litters \( L_1, L_2 \), the images \( \rho^\star_A(\NL(L_1)) \) and \( \rho^\star_A(\NL(L_2)) \) are disjoint.

\subsection{Injectivity}

We have fully described \( \rho^\star \); we will now show that the \( \rho^\star_A \) are near-litter permutations.
The first step in this process is proving injectivity of the \( \rho^\star_A \).

In particular, for a given pair of addresses \( x, y \), we will write
\[ \psi^{x,y} = \psi^s;\quad s = \{z \mid z \leq x \text{ or } z \leq y\} \]
We will prove injectivity by induction along two addresses at once, and our inductive hypothesis will be that \( \psi^{x,y} \) is lawful.
Given this hypothesis, we can immediately show that injectivity of atoms extends to the current stage.

\begin{lemma}
    \label{lem:atom_injective}
    Suppose \( \psi^{x,y} \) is lawful.
    Let \( A \) be an extended index, and let \( a, b \) be atoms such that \( (A, a) \leq x \) or \( y \), and \( (A, b) \leq x \) or \( y \).
    Then if \( \rho^\star_A(a) = \rho^\star_A(b) \), we have \( a = b \).
\end{lemma}
\begin{proof}
    If both \( a \) and \( b \) lie in \( \dom (\psi_A)^A \), this holds by injectivity of \( \psi_A \).
    If just one lies in the domain, this holds as the image of the other atom lies in \( L^- \) for some litter.
    In the other case, \( \rho^\star_A(a^\circ) = \rho^\star_A(b^\circ) \) so \( a^\circ = b^\circ \) by assumption, so we can reverse the bijection \( \pi_{a^\circ, \rho^\star_A(a^\circ)} = \pi_{b^\circ, \rho^\star_A(b^\circ)} \) to show \( a = b \).
\end{proof}

\begin{lemma}[coherence lemma]
    \label{lem:coherence}
    Let \( A \) be a path \( \beta \rightsquigarrow \gamma \) where \( \gamma \) is a proper type index, and let \( B \) be a \( \gamma \)-extended type index.
    Let \( s \) be a small set of \( \beta \)-addresses such that \( \psi^s \) is lawful, and let \( \psi^s_A \) exactly approximate the \( \gamma \)-allowable permutation \( \rho \) (under the conversion to an approximation given in \cref{lem:foa:struct_action_to_approx}).
    Let \( x \) be an address such that \( (A \gg \pr_1 x, \pr_2 x) \leq y \) for some \( y \in s \).
    Then
    \[ \rho^\star_A(x) = \rho(x) \]
\end{lemma}
\begin{proof}
    We proceed by induction along the relation \( < \) for \( \gamma \)-addresses.
    The result for atom addresses is simple, and the result for near-litter addresses reduces to that for litter addresses.
    It suffices to show, for every \( \gamma \)-extended index \( B \) and litter \( L \) such that \( (A \gg B, \NL(L)) \leq y \) for some \( y \in s \),
    \[ \rho^\star_{A \gg B}(L) = \rho_B(L) \]
    The case where \( L \) is \( B \)-flexible is easy, as is the case where \( L = f_{\bot,\zeta}(a) \).
    Suppose that
    \[ L = f_{\varepsilon,\zeta}(t);\quad t \in \tau_\varepsilon;\quad B = C \gg (\delta > \zeta > \bot) \]
    The coherence condition gives
    \[ \rho_{C \gg (\delta > \zeta > \bot)}(f_{\varepsilon,\zeta}(t)) = f_{\varepsilon,\zeta}(\rho_{C \gg (\delta > \varepsilon)}(t)) \]
    By the inductive hypothesis, \( \psi^s \) is lawful, so the structural action \( \psi^x \) defined in \cref{ss:foa:inflexible_coe} is also lawful.
    Therefore, by construction,
    \[ \rho^\star_{A \gg C \gg (\delta > \zeta > \bot)}(f_{\varepsilon,\zeta}(t)) = f_{\varepsilon,\zeta}(\rho^x(t)) \]
    where \( \rho^x \) is an \( \varepsilon \)-allowable permutation made from \( \psi^x \).
    Thus, it suffices to show that
    \[ \rho_{C \gg (\delta > \varepsilon)}(t) = \rho^x(t) \]
    We show that both of these \( \varepsilon \)-allowable permutations have the same action on the support of \( t \).
    It suffices by \cref{lem:exact} to show that they are exact before all addresses in this support, and this simply follows from the fact that both \( \rho \) and \( \rho^x \) came from applying \cref{lem:foa:struct_action_to_approx} to \( \rho^\star \).
\end{proof}

\begin{corollary}
    \label{cor:foa_both}
    Suppose that \( \psi^{x,y} \) is lawful.
    Let \( A \) be a path \( \beta \rightsquigarrow \gamma \) and let \( t \in \tau_\delta \).
    Let \( L = f_{\delta,\varepsilon}(t) \) be a litter such that \( (A, \NL(L)) \leq x \).
    Then
    \[ \rho^x_{(A \gg (\gamma > \delta))}(t) = \rho^{x,y}_{(A \gg (\gamma > \delta))}(t) \]
    where \( \rho^s \) is the allowable permutation obtained from applying freedom of action to \( \psi^s \) as in \cref{ss:foa:inflexible_coe}.
\end{corollary}
This follows directly from applying the coherence lemma to each address in the support of \( t \).

\begin{lemma}
    \label{lem:litter_injective}
    Suppose \( \psi^{x,y} \) is lawful.
    Let \( A \) be an extended index, and let \( L_1, L_2 \) be litters such that \( (A, \NL(L_1)) \leq x \) or \( y \), and \( (A, \NL(L_2)) \leq x \) or \( y \).
    Then if \( \rho^\star_A(L_1) = \rho^\star_A(L_2) \), we have \( L_1 = L_2 \).
\end{lemma}
\begin{proof}
    Note that \( \rho^\star_A \) maps \( A \)-flexible litters to \( A \)-flexible litters, and the same holds for \( A \)-inflexible litters.
    Thus, \( L_1 \) is \( A \)-flexible precisely when \( L_2 \) is.
    If \( L_1 \) and \( L_2 \) are \( A \)-flexible, then the values of \( \rho^\star_A(L_1) \) and \( \rho^\star_A(L_2) \) are given by applying the same partial permutation as defined in \cref{ss:foa:flexible}, so we must have \( L_1 = L_2 \).

    If \( L_i = f_{\bot,\varepsilon}(a_i) \) and \( A = B \gg (\gamma > \varepsilon > \bot) \), then by \cref{ss:foa:inflexible_bot},
    \[ \rho^\star_A(L_i) = f_{\bot,\varepsilon}(\rho^\star_{(A \gg (\gamma > \bot))}(a_i)) \]
    Hence, by injectivity of the fuzz map and lawfulness of \( \psi^{x,y} \), we must have \( a_1 = a_2 \), giving the result.

    Now suppose \( L_i = f_{\delta,\varepsilon}(t_i) \) and \( A = B \gg (\gamma > \varepsilon > \bot) \).
    \[ \rho^\star_A(L_i) = f_{\delta,\varepsilon}(\rho^z_{(A \gg (\gamma > \delta))}(t_i)) \]
    where \( z \) is either \( x \) or \( y \).
    By \cref{cor:foa_both}, we obtain
    \[ f_{\delta,\varepsilon}(\rho^{x,y}_{(A \gg (\gamma > \delta))}(t_1)) = f_{\delta,\varepsilon}(\rho^{x,y}_{(A \gg (\gamma > \delta))}(t_2)) \]
    and thus \( t_1 = t_2 \).
\end{proof}

\begin{lemma}
    All of the \( \psi^{x,y} \) are lawful.
\end{lemma}
\begin{proof}
    We proceed by induction on the relation on pairs of addresses given by
    \begin{alignat*}{5}
        (x_1, y) &\vartriangleleft (x_2, y) && \quad\text{if }\quad & x_1 &\prec x_2 \\
        (x, y_1) &\vartriangleleft (x, y_2) && \quad\text{if }\quad & y_1 &\prec y_2 \\
        (z_1, z_2) &\vartriangleleft (x, y) && \quad\text{if }\quad & z_1, z_2 &\prec x \\
        (z_1, z_2) &\vartriangleleft (x, y) && \quad\text{if }\quad & z_1, z_2 &\prec y
    \end{alignat*}
    This is well-founded, and the inductive hypothesis is the precise form needed to show lawfulness from \cref{lem:atom_injective,lem:litter_injective}.
    Part (iii) of the definition of lawfulness requires some simple explicit checking.
\end{proof}

\begin{corollary}
    The \( \rho^\star_A \) maps are injective on atoms and litters, and atoms inside litters are mapped inside the corresponding image near-litter.
\end{corollary}
\begin{corollary}
    All of the \( \psi^s \) are lawful.
\end{corollary}

\subsection{Surjectivity}

As with injectivity, the result for atoms is easy to prove.

\begin{lemma}
    Suppose \( A \) is a \( \beta \)-extended index and \( a \) is an atom such that \( a^\circ \in \ran \rho^\star_A \).
    Then \( a \in \ran \rho^\star_A \).
\end{lemma}
\begin{proof}
    Either \( a \in \dom (\psi_A)^A \), in which case \( a \in \ran (\psi_A)^A \) as required, or \( a \in (a^\circ)^- \), in which case the result holds.
\end{proof}

We will prove the result for near-litters from the following result on litters.

\begin{lemma}
    Let \( A \) be a \( \beta \)-extended index and let \( L \) be a litter.
    Suppose that for all \( x \prec (A, \NL(L)) \), we have \( \pr_2 x \in \ran \rho^\star_{\pr_1 x} \).
    Then \( L \in \ran \rho^\star_A \).
\end{lemma}
\begin{proof}
    If \( L \) is \( A \)-flexible or \( L = f_{\bot,\varepsilon}(a) \), the result is clear.
    Suppose \( A = B \gg (\gamma > \varepsilon > \bot) \) and \( L = f_{\delta,\varepsilon}(t) \).
    We claim that
    \[ L = \rho^\star_A(f_{\delta,\varepsilon}((\rho^s)^{-1}(t))) \]
    where
    \[ s = {(\rho^\star)^{-1}} '' \{ d \mid d < (A, L) \} \]
    Note that \( s \) is small as \( \rho^\star \) is injective on addresses.
    Let \( \rho^x \) be the allowable permutation obtained in \cref{ss:foa:inflexible_coe}, so
    \[ \rho^\star_A\left(f_{\delta,\varepsilon}\left((\rho^s_{B \gg (\gamma > \delta)})^{-1}(t)\right)\right) = f_{\delta,\varepsilon}\left(\rho^x\left((\rho^s_{B \gg (\gamma > \delta)})^{-1}(t)\right)\right) \]
    We show that
    \[ (\rho^x)^{-1}(t) = \left(\rho^s_{B \gg (\gamma > \delta)}\right)^{-1}(t) \]
    from which we obtain the desired result.
    It suffices to check the action on addresses \( y \in \supp t \):
    \[ (\rho^x)^{-1}(y) = \left(\rho^s_{B \gg (\gamma > \delta)}\right)^{-1}(y) \]
    By assumption, \( y = \rho^\star_{B \gg (\gamma > \delta)}(z) \) for some \( z \); it therefore suffices to show that
    \[ \rho^x(z) = \rho^\star_{B \gg (\gamma > \delta)}(z) = \rho^s_{B \gg (\gamma > \delta)}(z) \]
    The coherence lemma (\cref{lem:coherence}) immediately gives the right-hand equality.
    It also gives the left-hand equality, but with slightly more work; we must show that
    \[ (B \gg (\gamma > \delta) \gg \pr_1 z, \pr_2 z) < \left(B \gg (\gamma > \varepsilon > \bot), f_{\delta,\varepsilon}\left((\rho^s_{B \gg (\gamma > \delta)})^{-1}(t)\right)\right) \]
    But since allowable permutations commute with supports, we can deduce \( z \in \supp (\rho^s_{B \gg (\gamma > \delta)})^{-1}(t) \) from the fact that
    \[ \rho^s_{B \gg (\gamma > \delta)}(z) = \rho^\star_{B \gg (\gamma > \delta)}(z) = y \in \supp t \]
\end{proof}

\subsection{Finishing the proof}

We can now prove the freedom of action theorem, which states the following.

\begin{theorem*}[freedom of action, restatement of \cref{thm:foa}]
    Let \( \beta \leq \alpha \) be a proper type index.
    Then any free \( \beta \)-structural approximation \( \varphi \) approximates some \( \beta \)-allowable permutation \( \rho \).
\end{theorem*}
\begin{proof}
    We proceed by induction on \( \beta \).
    Let \( \varphi \) be a free \( \beta \)-structural approximation, and let \( \rho^\star \) be the map as defined in \cref{ss:foa:construction}.
    For any path \( A : \beta \rightsquigarrow \gamma \), we will say that \( \rho^\star \) is \emph{allowable below \( A \)} if there is a \( \gamma \)-allowable permutation \( \rho \) such that \( \rho^\star_A \) and \( \rho \) agree.
    We first show that for each \( \beta \)-extended index \( A \), \( \rho^\star \) is allowable below \( A \).
    But a \( \bot \)-allowable permutation is precisely a near-litter permutation, and each \( \rho^\star_A \) is a permutation of atoms and preserves near-litters as required.

    Now, let \( A : \beta \rightsquigarrow \gamma \) where \( \gamma \) is a proper type index.
    We show that \( \rho \) is allowable below \( A \) given that it is allowable below \( A \gg (\gamma > \delta) \) for all type indices \( \delta < \gamma \).
    Hypothesis (v) in \cref{ss:foa:hypotheses} allows us to construct a suitable allowable permutation; it suffices to check the coherence condition, which holds by construction.
    Hence, by induction on \( \gamma \), \( \rho^\star \) is allowable below every path, and in particular below the empty path, giving a \( \beta \)-allowable permutation \( \rho \) that coincides with \( \rho^\star \) everywhere.
    One can check that \( \varphi \) exactly aproximates \( \rho \); this is a simple computation.
\end{proof}

\subsection{Corollaries}

While \cref{thm:foa} is comparatively simple to state, the data that we want to combine into an allowable permutation rarely takes the form of a free structural approximation.
In this subsection, we describe a necessary criterion for partial functions of atoms and near-litters to come from an allowable permutation.

\begin{definition}
    A \emph{near-litter behaviour} is a pair \( \xi = (\xi^A, \xi^N) \) where \( \xi^A \) is a partial function from atoms to atoms and \( \xi^N \) is a partial function from near-litters to near-litters, such that the domains of \( \xi^A \) and \( \xi^N \) are small.
    A \emph{\( \beta \)-structural behaviour} assigns to each \( \beta \)-extended index \( A \) a near-litter behaviour \( \xi_A \).
\end{definition}

\begin{definition}
    A near-litter behaviour \( \xi \) \emph{approximates} a near-litter permutation \( \pi \) if \( \xi(a) = \pi(a) \) and \( \xi(N) = \pi(N) \) for all \( a \in \dom \xi^A \) and \( N \in \dom \xi^N \).
    Analogously, a structural behaviour \( \xi \) \emph{approximates} a structural permutation \( \pi \) if \( \xi_A \) approximates \( \pi_A \).
\end{definition}

We will describe a sufficient condition for a structural behaviour to approximate some allowable permutation.

\begin{definition}
    \label{def:foa:beh_lawful}
    A near-litter behaviour \( \xi \) is said to be \emph{lawful} if it satisfies
    \begin{enumerate}
        \item \( \xi^A \) is injective on its domain;
        \item if \( a \in \dom \xi^A \) and \( N \in \dom \xi^N \), then \( a \in N \leftrightarrow \xi(a) \in \xi(N) \);
        \item if \( N_1, N_2 \in \dom \xi^N \) and \( N_1^\circ = N_2^\circ \), then \( N_1 \symmdiff N_2 \subseteq \dom \xi^A \) and \( \xi(N_1) \symmdiff \xi(N_2) \subseteq \ran \xi^A \);
        \item if \( N_1, N_2 \in \dom \xi^N \) and \( N_1^\circ \neq N_2^\circ \), then \( N_1 \cap N_2 \subseteq \dom \xi^A \) and \( \xi(N_1) \cap \xi(N_2) \subseteq \ran \xi^A \).
    \end{enumerate}
    We say that a structural behaviour \( \xi \) is lawful if \( \xi_A \) is lawful for all \( A \).
\end{definition}

\begin{remark}
    From this, we can deduce that for \( N_1, N_2 \in \dom \xi^N \), we have \( N_1^\circ = N_2^\circ \leftrightarrow \xi(N_1)^\circ = \xi(N_2)^\circ \).
    This follows from the fact that \( \dom \xi^A \) is small by considering the cardinality of the relevant intersections.
\end{remark}

We describe a procedure for converting near-litter behaviours into near-litter actions.
This allows us to use \cref{lem:foa:nl_action_to_approx} to turn them into approximations, and then apply freedom of action.

\begin{lemma}
    \label{lem:foa:beh_to_action}
    Any lawful near-litter behaviour \( \xi \) can be extended to one defined on \( \NL(L) \) for all litters \( L = N^\circ \) for \( N \in \dom \xi^N \).
\end{lemma}
\begin{proof}
    We first add the atoms in one of the \( N \symmdiff \LS(N^\circ) \) to \( \xi \); there are only a small amount of these, so the result will be a near-litter behaviour.
    First suppose that \( L \) is a litter and
    \[ a \in \left(\bigcap_{N \in \dom \xi^N, N^\circ = L} N \setminus \LS(L)\right) \setminus \dom \xi^A \]
    We must allocate an image for \( a \) in the set
    \[ \left(\bigcap_{N \in \dom \xi^N, N^\circ = L} \xi(N)\right) \setminus \ran \xi^A \]
    This set is not small, so this allocation can always be done.
    Note that this set depends on the value of \( L \), which is unique for a given \( a \); if it were not, \( a \) would lie in the domain of \( \xi^A \) by part (iv) of \cref{def:foa:beh_lawful}.
    Instead, suppose that
    \[ a \in \left[\bigcup_{N \in \dom \xi^N} \LS(N^\circ) \setminus \bigcup_{N' \in \dom \xi^N} N' \right] \setminus \dom \xi^A \]
    Pick a litter \( L \) such that
    \[ \left(\ran \xi^A \cup \bigcup \ran \xi^N\right) \cap \LS(L) = \varnothing \]
    This can always be done as there are \( \mu \) litters but the amount of litters banned by the left-hand side is small.
    We allocate images for all atoms of this form inside \( \LS(L) \).
    One can check that this operation is well-defined and defines images of atoms \( a \in N \symmdiff \LS(N^\circ) \) for all \( N \in \dom \xi^N \).

    We now define the action of \( \xi \) on a litter \( L \) such that \( L = N^\circ \) for some \( N \in \dom \xi^N \).
    \[ \xi(\NL(L)) = \xi(N) \symmdiff \{ \xi(a) \mid a \in N \symmdiff \LS(N^\circ) \} \]
    This definition does not depend on the choice of \( N \), because for any other \( N' \) such that \( {N'}^\circ = L \), part (iii) of \cref{def:foa:beh_lawful} fixes any problematic atoms.
    One then checks directly that this behaviour is lawful.
\end{proof}

\begin{definition}
    \label{def:foa:beh_coherent}
    A \( \beta \)-structural behaviour \( \xi \) is said to be \emph{coherent} if it satisfies the following conditions.
    \begin{enumerate}
        \item For every extended index \( A : \beta \rightsquigarrow \bot \) and near-litter \( N \in \dom (\xi_A)^N \), if \( N^\circ \) is \( A \)-flexible then \( \xi(N)^\circ \) is \( A \)-flexible.
        \item Let \( A : \beta \rightsquigarrow \gamma \) and \( \delta, \varepsilon < \gamma \) be distinct proper type indices.
        Let \( t \) be a \( \delta \)-tangle, and let \( N \) be a near-litter such that \( N^\circ = f_{\delta,\varepsilon}(t) \) and
        \[ N \in \dom \left(\xi_{A \gg (\gamma > \varepsilon > \bot)}\right)^N \]
        Then for all addresses \( (B, x) \in \ran \supp t \), we have
        \[ x \in \dom \xi_{A \gg (\gamma > \delta) \gg B} \]
        Moreover, in this situation, if \( \rho \) is \( \gamma \)-allowable and satisfies
        \[ \xi_{A \gg (\gamma > \delta) \gg B}(x) = \rho_{(\gamma > \delta) \gg B}(x) \]
        for each such address, then
        \[ \xi_{A \gg (\gamma > \varepsilon > \bot)}(N)^\circ = f_{\delta,\varepsilon}(\rho_{(\gamma > \delta)}(t)) \]
        \item Let \( A : \beta \rightsquigarrow \gamma \) and \( \varepsilon < \gamma \) be a proper type index.
        Then for all atoms \( a \) and near-litters \( N \) such that \( N^\circ = f_{\bot,\varepsilon}(a) \) and
        \[ N \in \dom \left(\xi_{A \gg (\gamma > \varepsilon > \bot)}\right)^N \]
        we have
        \[ a \in \dom \left(\xi_{A \gg (\gamma > \bot)}\right)^A \]
        Moreover, in this situation, if \( \rho \) is \( \gamma \)-allowable and satisfies
        \[ \xi_{A \gg (\gamma > \bot)}(a) = \rho_{(\gamma > \bot)}(a) \]
        then
        \[ \xi_{A \gg (\gamma > \varepsilon > \bot)}(N)^\circ = f_{\bot,\varepsilon}(\rho_{(\gamma > \bot)}(a)) \]
    \end{enumerate}
\end{definition}

We can now state freedom of action for behaviours.

\begin{theorem}
    \label{thm:foa_behaviour}
    Every \( \beta \)-structural behaviour \( \xi \) that is both lawful and coherent approximates some \( \beta \)-allowable permutation \( \rho \).
\end{theorem}
\begin{proof}
    Augment \( \xi \) so that it is defined on all litters by using \cref{lem:foa:beh_to_action}.
    Define a structural action \( \psi \) by
    \[ (\psi_A)^A(a) = (\xi_A)^A(a);\quad (\psi_A)^L(L) = (\xi_A)^N(\NL(L)) \]
    One easily checks that this is a lawful action.
    By \cref{lem:foa:struct_action_to_approx}, we can convert it to a structural approximation \( \varphi \); we can do this by part (i) of the fact that \( \xi \) is coherent.
    We apply freedom of action to obtain a \( \beta \)-allowable permutation \( \rho \) that \( \varphi \) approximates.
    By induction on addresses, we can show directly that \( \xi \) has the same action as \( \rho \) on all addresses in its domain.
    The hypothesis needed for this induction to work is precisely parts (ii) and (iii) of the fact that \( \xi \) is coherent, as well as part (iii) of \cref{lem:foa:struct_action_to_approx}.
\end{proof}

Thus, we have established a sufficient condition for partial functions on atoms and near-litters to arise from an allowable permutation; it suffices to check that the corresponding behaviour is lawful and coherent.
